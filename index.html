<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆå®Œå…¨å‹•ä½œãƒ»é…ç½®ä¿®æ­£ç‰ˆï¼‰</title>
    <style>
        /* --- ãƒªã‚»ãƒƒãƒˆ & åŸºæœ¬è¨­å®š --- */
        html, body {
            height: 100%;
            margin: 0; padding: 0;
            overflow: hidden;
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f8fafc;
            color: #333;
            user-select: none;
        }

        /* --- ã‚³ãƒ³ãƒ†ãƒŠ --- */
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        .header-area {
            flex: 0 0 auto;
            text-align: center;
            margin-bottom: 5px;
            padding-top: 10px;
        }
        h1 { margin: 0; font-size: 1.2rem; color: #334155; }
        .subtitle { margin: 0; color: #64748b; font-size: 0.75rem; }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ --- */
        .stage {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 0.9fr 1fr;
            gap: 10px;
            min-height: 0;
        }

        /* --- ã‚¾ãƒ¼ãƒ³ --- */
        .zone {
            background: #fff;
            border-radius: 8px;
            border-top: 4px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            padding: 8px;
            height: 100%;
            box-sizing: border-box;
            position: relative;
        }
        .zone.sender { border-color: #3b82f6; background: #eff6ff; }
        .zone.network { border-color: #ef4444; background: #fff1f2; opacity: 0.5; transition: 0.5s; }
        .zone.receiver { border-color: #22c55e; background: #f0fdf4; }
        .zone.active { opacity: 1; }

        h2 { font-size: 0.95rem; text-align: center; margin: 0 0 5px 0; flex: 0 0 auto; }
        .label { font-size: 0.7rem; font-weight: bold; color: #64748b; margin-bottom: 2px; display: block; text-align: center; flex: 0 0 auto; }

        /* --- ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª & ä½œæ¥­å° --- */
        .inventory {
            background: rgba(255,255,255,0.6);
            border: 2px dashed #cbd5e1; border-radius: 8px;
            padding: 5px;
            flex: 0 0 auto;
            min-height: 90px;
            display: flex; justify-content: center; align-items: center; gap: 5px;
            z-index: 5;
        }
        .workbench {
            margin-top: 5px;
            flex: 1;
            background: #fff;
            border: 2px solid #e2e8f0; border-radius: 8px;
            padding: 5px;
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: visible;
        }

        /* --- ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ --- */
        .item {
            background: white;
            border: 1px solid #94a3b8;
            border-radius: 6px;
            padding: 2px;
            width: 85px; height: 75px; 
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
            position: relative; z-index: 10;
            box-sizing: border-box;
        }
        .item-icon { font-size: 1.4rem; line-height: 1; margin-top: 4px; }
        .item-text-group { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 2px; }
        .item-name { font-size: 10px; font-weight: bold; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .item-sub { font-size: 9px; color: #666; line-height: 1; white-space: nowrap; margin-top: 1px; }

        .i-file { border-bottom: 4px solid #3b82f6; }
        .i-priv { border-bottom: 4px solid #ef4444; background: #fff5f5; }
        .i-cert { border-bottom: 4px solid #f59e0b; background: #fffbeb; }
        .i-pub  { border-bottom: 4px solid #22c55e; background: #f0fdf4; border: 2px solid #22c55e; }
        .i-hash { border-bottom: 4px solid #64748b; background: #f8fafc; border-style: dashed; }
        .i-sig  { border-bottom: 4px solid #8b5cf6; background: #f5f3ff; }
        .i-bad  { border-bottom: 4px solid #dc2626; background: #fee2e2; color: #991b1b; }

        /* --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¡ --- */
        .flying-obj {
            position: fixed; z-index: 9999;
            transition: all 2.5s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            pointer-events: none; transform-origin: center; margin: 0;
            transform: scale(1.1);
        }
        .process-stage { display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 5px; width: 100%; opacity: 0; transition: opacity 0.5s; }
        .process-stage.visible { opacity: 1; }
        .placeholder { width: 85px; height: 75px; visibility: hidden; }
        .proc-arrow, .proc-plus { font-size: 1.2rem; color: #94a3b8; font-weight: bold; }
        .effect-icon { font-size: 2rem; display: block; margin: 5px 0; }
        .spin { animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .lock-anim { animation: lock 2s infinite; }
        @keyframes lock { 0% { transform: scale(1); } 50% { transform: scale(1.2); color: #ef4444; } 100% { transform: scale(1); } }
        @keyframes keyTurn { 0% { transform: rotate(0deg); } 20% { transform: rotate(-30deg); } 60% { transform: rotate(60deg); } 100% { transform: rotate(0deg); } }
        .key-anim { animation: keyTurn 1.5s infinite; display: inline-block; }
        .pop-up { animation: popUp 0.8s; }
        @keyframes popUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .fade-in { animation: fadeIn 1s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .highlight { animation: pulse 1.5s infinite; border-color: #f59e0b !important; box-shadow: 0 0 10px rgba(245, 158, 11, 0.8) !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- ãƒœã‚¿ãƒ³ --- */
        button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 0.9rem; box-shadow: 0 3px 0 rgba(0,0,0,0.2); transition: all 0.2s; flex: 0 0 auto; }
        button:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
        button:disabled { background: #cbd5e1 !important; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-blue { background: #3b82f6; } .btn-red { background: #ef4444; } .btn-green { background: #22c55e; }
        .footer-area { flex: 0 0 auto; text-align: center; margin-top: 5px; }
        .btn-reset { background: #64748b; width: auto; min-width: 200px; padding: 8px 30px; display: inline-block; white-space: nowrap; font-size: 0.8rem; }

        .result-card { background: #fff; padding: 10px; border-radius: 8px; width: 100%; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.1); animation: popUp 0.5s; margin-top: 5px; font-size: 0.9em; box-sizing: border-box; }
        .res-ok { border: 2px solid #22c55e; background: #f0fdf4; color: #15803d; }
        .res-ng { border: 2px solid #ef4444; background: #fef2f2; color: #b91c1c; }

        /* --- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ --- */
        .msg-window {
            position: fixed;
            width: 320px;
            background: rgba(30, 41, 60, 0.95);
            color: #fff;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            z-index: 10000;
            overflow: hidden;
            transition: top 0.7s cubic-bezier(0.2, 0.8, 0.2, 1), left 0.7s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.15);
            
            /* åˆæœŸä½ç½®: ç”»é¢ä¸­å¤®ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ–‡å­—ã®ä¸‹ */
            top: 110px; left: 50%; transform: translateX(-50%);
        }

        .msg-handle {
            background: rgba(255,255,255,0.1);
            padding: 6px;
            cursor: grab;
            text-align: center;
            font-size: 0.75rem;
            color: #cbd5e1;
            user-select: none;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .msg-handle:active { cursor: grabbing; background: rgba(255,255,255,0.2); }
        
        .msg-content {
            padding: 16px 20px;
            text-align: center;
            font-weight: 500;
            font-size: 1rem;
            line-height: 1.6;
            
            /* â˜…ä¿®æ­£: æ—¥æœ¬èªã®è‡ªç„¶ãªæ”¹è¡Œ */
            word-wrap: break-word;
            overflow-wrap: anywhere;
            word-break: normal;
        }

        /* --- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆè¨¼æ˜æ›¸è§£èª¬ï¼‰ --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
            z-index: 11000;
        }
        .overlay.visible { opacity: 1; pointer-events: auto; }
        .overlay-card {
            background: white; width: 90%; max-width: 600px;
            padding: 30px; border-radius: 15px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .overlay.visible .overlay-card { transform: scale(1); }
        .overlay-icon { font-size: 4rem; display: block; margin-bottom: 15px; }
        .overlay-title { font-size: 1.5rem; margin: 0 0 15px 0; color: #1e293b; }
        .overlay-text { font-size: 1rem; color: #475569; line-height: 1.8; text-align: left; background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .overlay-btn { background: #3b82f6; color: white; border: none; padding: 12px 30px; font-size: 1rem; border-radius: 30px; cursor: pointer; transition: 0.3s; width: auto; display: inline-block;}
        .overlay-btn:hover { background: #2563eb; transform: scale(1.05); }

    </style>
</head>
<body>

<div id="msg-window" class="msg-window">
    <div id="msg-handle" class="msg-handle">
        â‰¡ èª¬æ˜ã‚¬ã‚¤ãƒ‰ (ãƒ‰ãƒ©ãƒƒã‚°å¯)
    </div>
    <div id="msg-text" class="msg-content">
        æº–å‚™å®Œäº†ã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é–‹å§‹ã€‚
    </div>
</div>

<div id="final-overlay" class="overlay">
    <div class="overlay-card">
        <span class="overlay-icon">ğŸ“</span>
        <h2 class="overlay-title">ãƒ‡ã‚¸ã‚¿ãƒ«è¨¼æ˜æ›¸ã¨ã¯ï¼Ÿ</h2>
        <div class="overlay-text">
            ãƒ‡ã‚¸ã‚¿ãƒ«è¨¼æ˜æ›¸ã¯ã€<strong>èªè¨¼å±€ (CA)</strong> ã¨å‘¼ã°ã‚Œã‚‹ä¿¡é ¼ã§ãã‚‹ç¬¬ä¸‰è€…æ©Ÿé–¢ï¼ˆä¾‹ï¼šDigiCert, GlobalSign, Let's Encrypt ãªã©ï¼‰ãŒç™ºè¡Œã—ã¾ã™ã€‚<br><br>
            ã“ã‚Œã¯<strong>ã€Œã“ã®å…¬é–‹éµã®æŒã¡ä¸»ã¯ã€é–“é•ã„ãªã ãã¾ï¼ˆé€ä¿¡è€…ï¼‰ ã§ã‚ã‚‹ã€</strong>ã“ã¨ã‚’è¨¼æ˜ã™ã‚‹ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®ã€Œèº«åˆ†è¨¼æ˜æ›¸ã€ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚
        </div>
        <button class="overlay-btn" onclick="closeOverlay()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div class="container">
    <div class="header-area">
        <h1>ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        <p class="subtitle">è¨¼æ˜æ›¸ã®å½¹å‰²ã¨ã€å…¬é–‹éµã«ã‚ˆã‚‹å¾©å·ã®æµã‚Œã‚’ç¢ºèª</p>
    </div>

    <div class="stage">
        <div class="zone sender" id="z-sender">
            <h2>ğŸ» é€ä¿¡è€…</h2>
            <span class="label">æŒã¡ç‰©</span>
            <div class="inventory" id="inv-sender">
                <div class="item i-file" id="item-s-file">
                    <span class="item-icon">ğŸ“„</span>
                    <div class="item-text-group"><span class="item-name">ãƒ•ã‚¡ã‚¤ãƒ«</span><span class="item-sub">åŸæ–‡</span></div>
                </div>
                <div class="item i-priv" id="item-s-priv">
                    <span class="item-icon">ğŸ—ï¸</span>
                    <div class="item-text-group"><span class="item-name">ç§˜å¯†éµ</span><span class="item-sub">è‡ªåˆ†ç”¨</span></div>
                </div>
                <div class="item i-cert" id="item-s-cert">
                    <span class="item-icon">ğŸªªğŸ”‘</span>
                    <div class="item-text-group"><span class="item-name">è¨¼æ˜æ›¸</span><span class="item-sub">å…¬é–‹éµå…¥</span></div>
                </div>
            </div>
            <div class="workbench">
                <span class="label">ä½œæ¥­å°</span>
                <div id="ws-sender" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
            </div>
            <button class="btn-blue" id="btn-step1" onclick="runSender()">1. ç½²åä½œæˆï¼†é€ä¿¡</button>
        </div>

        <div class="zone network" id="zone-net">
            <h2>ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ</h2>
            <div class="workbench" style="background:transparent; border:none; justify-content:center;">
                <div id="net-pkg"></div>
            </div>
            <button class="btn-red" id="btn-tamper" onclick="runTamper()" disabled>ğŸ˜ˆ ãƒ•ã‚¡ã‚¤ãƒ«æ”¹ã–ã‚“</button>
            <button class="btn-blue" id="btn-deliver" onclick="runDeliver()" disabled style="background:#475569;">2. å—ä¿¡è€…ã¸ â¡</button>
        </div>

        <div class="zone receiver" id="z-receiver">
            <h2>ğŸ‘¤ å—ä¿¡è€…</h2>
            <span class="label">æŒã¡ç‰©</span>
            <div class="inventory" id="inv-recv"><span style="color:#aaa; font-size:0.8em;">(å—ä¿¡å¾…ã¡)</span></div>
            <div class="workbench">
                <span class="label">æ¤œè¨¼å°</span>
                <div id="ws-recv" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
            </div>
            <button class="btn-green" id="btn-verify" onclick="runVerify()" disabled>3. æ¤œè¨¼ (ç­”ãˆåˆã‚ã›)</button>
        </div>
    </div>

    <div class="footer-area">
        <button class="btn-reset" onclick="location.reload()">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
    </div>
</div>

<script>
    const SPEED = { FLY: 2500, PROCESS: 3000 }; 
    let isTampered = false;
    let isRunning = false;

    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    const msgWindow = document.getElementById('msg-window');
    const msgText = document.getElementById('msg-text');

    // åˆæœŸé…ç½®
    window.onload = function() {
        snapMsgTo('zone-net', 'initial');
    };

    // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
    const handle = document.getElementById('msg-handle');
    let isDragging = false;
    let dragStartX, dragStartY;
    let initialLeft, initialTop;

    handle.addEventListener('mousedown', function(e) {
        isDragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        
        const rect = msgWindow.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;

        msgWindow.style.transition = 'none';
        msgWindow.style.transform = 'none';
        msgWindow.style.left = initialLeft + 'px';
        msgWindow.style.top = initialTop + 'px';

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });

    function onMouseMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        const dx = e.clientX - dragStartX;
        const dy = e.clientY - dragStartY;
        msgWindow.style.left = (initialLeft + dx) + 'px';
        msgWindow.style.top = (initialTop + dy) + 'px';
    }

    function onMouseUp() {
        isDragging = false;
        msgWindow.style.transition = 'top 0.7s cubic-bezier(0.2, 0.8, 0.2, 1), left 0.7s cubic-bezier(0.2, 0.8, 0.2, 1)';
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }

    // â˜…é…ç½®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ±ºå®šç‰ˆï¼‰
    function snapMsgTo(targetId, placement) {
        if (isDragging) return; 

        const target = document.getElementById(targetId);
        if (!target) return;

        const tRect = target.getBoundingClientRect();
        const mRect = msgWindow.getBoundingClientRect();
        const gap = 20; 

        let newTop, newLeft;

        // --- é…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³ ---
        if (placement === 'initial') {
            // åˆæœŸ: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆnet zoneï¼‰ã®ä¸Šéƒ¨å†…å´
            newLeft = tRect.left + (tRect.width / 2) - (mRect.width / 2);
            newTop = 110; 
        } 
        else if (placement === 'right-high') {
            // å³éš£ã‹ã¤é«˜ã‚ (é€ä¿¡ä¸­ç”¨) - ã‚¹ã‚¯ã‚·ãƒ§ã®ä½ç½®ã¸
            newLeft = tRect.right + gap;
            newTop = tRect.top - 50; 
        } 
        else if (placement === 'sender-safe-corner') {
            // â˜…ä¿®æ­£: é€ä¿¡è€…ã‚¾ãƒ¼ãƒ³ã®å·¦ä¸‹ï¼ˆä½œæ¥­å°ã®å·¦å´ï¼‰
            // ã“ã‚Œãªã‚‰æŒã¡ç‰©ï¼ˆä¸Šï¼‰ã‚‚ä½œæ¥­å°ï¼ˆä¸­ï¼‰ã‚‚éš ã•ãªã„
            const zoneSender = document.getElementById('z-sender').getBoundingClientRect();
            newLeft = zoneSender.left + 10;
            newTop = zoneSender.bottom - mRect.height - 10;
        } 
        else if (placement === 'left-of') {
            // å·¦éš£ (å—ä¿¡ä¸­ç”¨) - ä¸­å¤®ã‚¨ãƒªã‚¢ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆï¼‰
            newLeft = tRect.left - mRect.width - gap;
            newTop = tRect.top;
        }

        // ç”»é¢å¤–ã‚¬ãƒ¼ãƒ‰
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        if (newLeft + mRect.width > winW) newLeft = winW - mRect.width - 10;
        if (newLeft < 10) newLeft = 10;
        if (newTop + mRect.height > winH) newTop = winH - mRect.height - 10;
        if (newTop < 10) newTop = 10;

        // é©ç”¨
        msgWindow.style.transform = 'none'; 
        msgWindow.style.left = newLeft + 'px';
        msgWindow.style.top = newTop + 'px';
    }

    function msg(text) {
        msgText.innerHTML = text;
    }

    async function blinkMsg(text) {
        msg(text);
        await wait(3500); 
    }

    function toggleHighlight(id, on) {
        const el = document.getElementById(id);
        if(el) on ? el.classList.add('highlight') : el.classList.remove('highlight');
    }

    function closeOverlay() {
        document.getElementById('final-overlay').classList.remove('visible');
    }

    const createItemHTML = (type, icon, name, sub="", id="") => `
        <div class="item ${type}" ${id ? `id="${id}"` : ''}>
            <span class="item-icon">${icon}</span>
            <div class="item-text-group"><span class="item-name">${name}</span>${sub ? `<span class="item-sub">${sub}</span>` : ''}</div>
        </div>
    `;

    async function moveItemToTarget(sourceId, targetElem) {
        return new Promise((resolve) => {
            const src = document.getElementById(sourceId);
            const tgt = targetElem; 
            if (!src || !tgt) { resolve(); return; }
            const sRect = src.getBoundingClientRect();
            const tRect = tgt.getBoundingClientRect();
            const flyer = src.cloneNode(true);
            flyer.id = ""; flyer.classList.add('flying-obj'); flyer.classList.remove('highlight');
            flyer.style.width = '85px'; flyer.style.height = '75px'; 
            flyer.style.left = sRect.left + 'px'; flyer.style.top = sRect.top + 'px';
            document.body.appendChild(flyer);
            requestAnimationFrame(() => {
                flyer.style.left = tRect.left + 'px';
                flyer.style.top = tRect.top + 'px';
                flyer.style.transform = "scale(1.1)"; 
            });
            setTimeout(() => { flyer.remove(); resolve(); }, SPEED.FLY);
        });
    }

    // === ã‚·ãƒŠãƒªã‚ª ===

    // â–  Step 1: é€ä¿¡
    async function runSender() {
        if(isRunning) return; isRunning = true;
        document.getElementById('btn-step1').disabled = true;
        const ws = document.getElementById('ws-sender');

        // â˜…è‡ªå‹•ç§»å‹•: é€ä¿¡è€…ä½œæ¥­å°ã®å³å´ï¼ˆé«˜ã‚ï¼‰
        snapMsgTo('ws-sender', 'right-high');

        // 1. ãƒãƒƒã‚·ãƒ¥åŒ–
        msg("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæ¥­å°ã¸ç§»å‹•ã—ã¾ã™");
        toggleHighlight('item-s-file', true);
        await wait(2000); 

        ws.innerHTML = `
            <div class="process-stage" id="proc-1">
                <div class="placeholder" id="ph-s-file"></div>
                <div class="proc-arrow">â¡</div>
                <div style="text-align:center;">
                    <span class="effect-icon spin">âš™ï¸</span><small style="font-size:0.7em;">ãƒãƒƒã‚·ãƒ¥åŒ–</small>
                </div>
            </div>`;
        
        const phFile = document.getElementById('ph-s-file');
        await moveItemToTarget('item-s-file', phFile);
        phFile.outerHTML = createItemHTML('i-file', 'ğŸ“„', 'ãƒ•ã‚¡ã‚¤ãƒ«');
        document.getElementById('proc-1').classList.add('visible');
        toggleHighlight('item-s-file', false);

        await wait(2000); 

        await blinkMsg("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã—ã¾ã—ãŸã€‚ã“ã“ã‹ã‚‰è¨ˆç®—ã‚’å§‹ã‚ã¾ã™ã€‚");

        msg("ä½œæ¥­å°ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨ˆç®—ã—ã€ã€Œè¦ç´„ï¼ˆãƒãƒƒã‚·ãƒ¥å€¤ï¼‰ã€ã«å¤‰æ›ã—ã¦ã„ã¾ã™...");
        await wait(SPEED.PROCESS);
        
        await wait(2000); 

        document.getElementById('proc-1').innerHTML = `${createItemHTML('i-hash fade-in', 'ğŸ“¦', 'ãƒãƒƒã‚·ãƒ¥å€¤', 'è¦ç´„', 'temp-hash')}`;
        
        await blinkMsg("å¤‰æ›å®Œäº†ï¼ã€Œãƒãƒƒã‚·ãƒ¥å€¤ã€ãŒã§ãã¾ã—ãŸã€‚ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡ç´‹ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ï¼‰");
        await wait(2000); 

        // 2. ç½²åä½œæˆ
        msg("ã€Œç§˜å¯†éµã€ã‚’ç§»å‹•ã—ã¦æš—å·åŒ–ã—ã¾ã™");
        toggleHighlight('item-s-priv', true);
        toggleHighlight('temp-hash', true);
        await wait(2000); 

        ws.innerHTML = `
            <div class="process-stage visible" id="proc-2">
                ${createItemHTML('i-hash', 'ğŸ“¦', 'ãƒãƒƒã‚·ãƒ¥', 'è¦ç´„')}
                <div class="proc-plus">+</div>
                <div class="placeholder" id="ph-s-priv"></div>
                <div class="proc-arrow">â¡</div>
                <div style="text-align:center;">
                    <span class="effect-icon lock-anim">ğŸ”’</span><small style="font-size:0.7em;">æš—å·åŒ–</small>
                </div>
            </div>`;

        const phPriv = document.getElementById('ph-s-priv');
        await moveItemToTarget('item-s-priv', phPriv);
        phPriv.outerHTML = createItemHTML('i-priv', 'ğŸ—ï¸', 'ç§˜å¯†éµ', 'è‡ªåˆ†ç”¨');
        toggleHighlight('item-s-priv', false);

        await wait(2000); 

        await blinkMsg("ãƒãƒƒã‚·ãƒ¥å€¤ã¨ç§˜å¯†éµãŒæƒã„ã¾ã—ãŸã€‚ã“ã‚Œã‹ã‚‰ãƒ­ãƒƒã‚¯ï¼ˆæš—å·åŒ–ï¼‰ã—ã¾ã™ã€‚");

        msg("ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ã€Œç§˜å¯†éµã€ã§ãƒ­ãƒƒã‚¯ä¸­... ã“ã‚ŒãŒã€Œç½²åã€ã«ãªã‚Šã¾ã™ã€‚");
        await wait(SPEED.PROCESS);
        await wait(2000); 

        document.getElementById('proc-2').innerHTML = `${createItemHTML('i-sig fade-in', 'ğŸ–Šï¸ğŸ”’', 'ç½²å', 'æš—å·åŒ–æ¸ˆ', 'temp-sig')}`;

        await blinkMsg("ç½²åãŒå®Œæˆã—ã¾ã—ãŸï¼ï¼ˆãƒšãƒ³ã§ã‚µã‚¤ãƒ³ã—ã¦éµã‚’ã‹ã‘ãŸçŠ¶æ…‹ï¼‰");
        await wait(2000); 

        // 3. é€ä¿¡
        // â˜…ä¿®æ­£: é€ä¿¡å®Œäº†æ™‚ã€é€ä¿¡è€…ã‚¾ãƒ¼ãƒ³ã®å·¦ä¸‹ã¸é€€é¿
        snapMsgTo('z-sender', 'sender-safe-corner');

        msg("3ç‚¹ã‚»ãƒƒãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ç½²åãƒ»è¨¼æ˜æ›¸ï¼‰ã§é€ä¿¡ã—ã¾ã™ã€‚");
        toggleHighlight('item-s-file', true);
        toggleHighlight('item-s-cert', true);
        toggleHighlight('temp-sig', true);
        await wait(2000); 

        ws.innerHTML = "";
        toggleHighlight('item-s-file', false);
        toggleHighlight('item-s-cert', false);
        const netZone = document.getElementById('zone-net');
        netZone.classList.add('active');

        document.getElementById('net-pkg').innerHTML = `
            <div id="pkg-box" style="background:white; border:2px solid #333; padding:5px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2);">
                <div style="background:#333; color:white; font-size:0.7em; text-align:center; border-radius:4px; margin-bottom:5px;">ğŸ“¦ é…é€ã‚»ãƒƒãƒˆ</div>
                <div style="display:flex; gap:3px; justify-content:center;">
                    ${createItemHTML('i-file', 'ğŸ“„', 'ãƒ•ã‚¡ã‚¤ãƒ«', '')}
                    ${createItemHTML('i-sig', 'ğŸ–Šï¸ğŸ”’', 'ç½²å', '')}
                    ${createItemHTML('i-cert', 'ğŸªªğŸ”‘', 'è¨¼æ˜æ›¸', '')}
                </div>
            </div>`;
        
        // å†ç¢ºèª: é€€é¿ã‚’ç¶­æŒ
        snapMsgTo('z-sender', 'sender-safe-corner');

        await blinkMsg("é€ä¿¡å®Œäº†ï¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚");

        document.getElementById('btn-tamper').disabled = false;
        document.getElementById('btn-deliver').disabled = false;
        isRunning = false;
    }

    // â–  Step 2: æ”¹ã–ã‚“ã¨é…é€
    async function runTamper() {
        if(isTampered) return;
        
        // â˜…é€€é¿ä½ç½®ã‚’ã‚­ãƒ¼ãƒ—
        snapMsgTo('z-sender', 'sender-safe-corner');

        const pkg = document.getElementById('pkg-box');
        if(!pkg) return;
        const fileDiv = pkg.querySelector('.i-file');
        fileDiv.className = 'item i-bad';
        fileDiv.innerHTML = `<span class="item-icon">ğŸ“„</span><div class="item-text-group"><span class="item-name">å½ãƒ•ã‚¡ã‚¤ãƒ«</span><span class="item-sub">æ”¹ã–ã‚“</span></div>`;
        isTampered = true;
        
        await blinkMsg("ğŸ˜ˆ æ”¹ã–ã‚“ï¼ä¸­èº«ã‚’æ›¸ãæ›ãˆã¾ã—ãŸï¼ˆç½²åã¯ãã®ã¾ã¾ï¼‰");
        document.getElementById('btn-tamper').disabled = true;
    }

    async function runDeliver() {
        snapMsgTo('z-sender', 'sender-safe-corner');

        document.getElementById('net-pkg').innerHTML = "";
        document.getElementById('zone-net').classList.remove('active');
        document.getElementById('btn-deliver').disabled = true;
        document.getElementById('btn-tamper').disabled = true;
        
        const inv = document.getElementById('inv-recv');
        inv.innerHTML = "";
        const fType = isTampered ? 'i-bad' : 'i-file';
        const fName = isTampered ? 'å½ãƒ•ã‚¡ã‚¤ãƒ«' : 'ãƒ•ã‚¡ã‚¤ãƒ«';
        const fSub  = isTampered ? 'æ”¹ã–ã‚“' : 'å—ä¿¡';

        inv.innerHTML += createItemHTML(fType, 'ğŸ“„', fName, fSub, 'r-file');
        inv.innerHTML += createItemHTML('i-sig', 'ğŸ–Šï¸ğŸ”’', 'ç½²å', 'å—ä¿¡', 'r-sig');
        inv.innerHTML += createItemHTML('i-cert', 'ğŸªªğŸ”‘', 'è¨¼æ˜æ›¸', 'å…¬é–‹éµå…¥', 'r-cert');

        // â˜…ä½ç½®: å—ä¿¡è€…ä½œæ¥­å°ã®å·¦éš£ã¸
        snapMsgTo('ws-recv', 'left-of');

        await blinkMsg("å—ä¿¡è€…ã«å±Šãã¾ã—ãŸã€‚æ¤œè¨¼ï¼ˆç­”ãˆåˆã‚ã›ï¼‰ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚");
        document.getElementById('btn-verify').disabled = false;
    }

    // â–  Step 3: æ¤œè¨¼
    async function runVerify() {
        if(isRunning) return; isRunning = true;
        document.getElementById('btn-verify').disabled = true;
        const ws = document.getElementById('ws-recv');

        // â˜…å·¦éš£ã‚’ã‚­ãƒ¼ãƒ—
        snapMsgTo('ws-recv', 'left-of');

        msg("æ¤œè¨¼é–‹å§‹ã€‚2ã¤ã®ãƒ«ãƒ¼ãƒˆã§æ¯”è¼ƒã—ã¾ã™ã€‚");
        ws.innerHTML = `
            <div style="display:flex; justify-content:space-between; width:100%; gap:5px; align-items:start;">
                <div id="route-a" style="flex:1; background:#f8fafc; padding:5px; border-radius:8px; display:flex; flex-direction:column; align-items:center; border:1px solid #ccc;">
                    <span class="label" style="margin-bottom:5px;">A:ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰</span>
                    <div id="box-a" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
                </div>
                <div style="display:flex; align-items:center; font-weight:bold; font-size:1.5em; color:#999; margin-top:30px;">vs</div>
                <div id="route-b" style="flex:1; background:#f8fafc; padding:5px; border-radius:8px; display:flex; flex-direction:column; align-items:center; border:1px solid #ccc;">
                    <span class="label" style="margin-bottom:5px;">B:ç½²åã‹ã‚‰</span>
                    <div id="box-b" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
                </div>
            </div>
            <div id="final-result"></div>`;
        const boxA = document.getElementById('box-a');
        const boxB = document.getElementById('box-b');
        await wait(2000); 

        // Route A
        msg("ãƒ«ãƒ¼ãƒˆAï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œè¦ç´„ã€ã«æˆ»ã—ã¾ã™");
        toggleHighlight('r-file', true);
        await wait(2000); 

        boxA.innerHTML = `<div class="process-stage" id="proc-a"><div class="placeholder" id="ph-r-file"></div><div class="proc-arrow">â¡</div><div class="effect-icon spin" style="font-size:1.5em;">âš™ï¸</div></div>`;
        const phRFile = document.getElementById('ph-r-file');
        await moveItemToTarget('r-file', phRFile);
        const fType = isTampered ? 'i-bad' : 'i-file';
        const fName = isTampered ? 'å½ãƒ•ã‚¡ã‚¤ãƒ«' : 'ãƒ•ã‚¡ã‚¤ãƒ«';
        const fSub  = isTampered ? 'æ”¹ã–ã‚“' : 'å—ä¿¡';
        phRFile.outerHTML = createItemHTML(fType, 'ğŸ“„', fName, fSub);
        document.getElementById('proc-a').classList.add('visible');
        toggleHighlight('r-file', false);

        await wait(2000); 

        await blinkMsg("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã—ã¾ã—ãŸã€‚ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å†è¨ˆç®—ã—ã¾ã™ã€‚"); 
        await wait(SPEED.PROCESS);
        await wait(2000); 

        const hashType = isTampered ? 'i-bad' : 'i-hash';
        const hashName = isTampered ? 'å½ãƒãƒƒã‚·ãƒ¥' : 'ãƒãƒƒã‚·ãƒ¥å€¤';
        boxA.innerHTML = `<span class="label">çµæœ</span>${createItemHTML(hashType + ' fade-in', 'ğŸ“¦', hashName, 'è¨ˆç®—çµæœ')}`;
        await blinkMsg("ãƒ«ãƒ¼ãƒˆAå®Œäº†ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥å€¤ãŒå‡ºã¾ã—ãŸã€‚"); 
        await wait(2000); 


        // Route B
        msg("ãƒ«ãƒ¼ãƒˆBï¼šç½²åã¨è¨¼æ˜æ›¸ã‚’ä½œæ¥­å°ã¸ã€‚");
        toggleHighlight('r-sig', true);
        toggleHighlight('r-cert', true);
        await wait(2000); 

        boxB.innerHTML = `<div class="process-stage" id="proc-b"><div class="placeholder" id="ph-r-sig"></div><div class="proc-plus">+</div><div class="placeholder" id="ph-r-cert"></div></div>`;
        const phRSig = document.getElementById('ph-r-sig');
        const phRCert = document.getElementById('ph-r-cert');
        await Promise.all([moveItemToTarget('r-sig', phRSig), moveItemToTarget('r-cert', phRCert)]);
        phRSig.outerHTML = createItemHTML('i-sig', 'ğŸ–Šï¸ğŸ”’', 'ç½²å', 'å—ä¿¡');
        phRCert.outerHTML = createItemHTML('i-cert', 'ğŸªªğŸ”‘', 'è¨¼æ˜æ›¸', 'å…¬é–‹éµå…¥');
        document.getElementById('proc-b').classList.add('visible');
        toggleHighlight('r-sig', false);
        toggleHighlight('r-cert', false);

        await wait(2000); 

        await blinkMsg("è¨¼æ˜æ›¸ãŒå±Šãã¾ã—ãŸã€‚èªè¨¼å±€(CA)ã®ä¿è¨¼ä»˜ãã§ã™ã€‚");

        msg("è¨¼æ˜æ›¸ã®ä¸­ã‹ã‚‰ã€æœ¬ç‰©ã¨è¨¼æ˜ã•ã‚ŒãŸã€Œå…¬é–‹éµã€ã‚’å–ã‚Šå‡ºã—ã¾ã™ï¼");
        await wait(2000); 
        
        document.getElementById('proc-b').innerHTML = `${createItemHTML('i-sig', 'ğŸ–Šï¸ğŸ”’', 'ç½²å', 'å—ä¿¡')}<div class="proc-plus">+</div>${createItemHTML('i-pub pop-up', 'ğŸ”‘', 'å…¬é–‹éµ', 'æŠ½å‡º')}`;
        await wait(2000); 

        await blinkMsg("ã€Œå…¬é–‹éµã€ã‚’å–ã‚Šå‡ºã—ã¾ã—ãŸï¼ã“ã‚Œã§ç½²åã®ãƒ­ãƒƒã‚¯ã‚’è§£ãã¾ã™ã€‚");

        msg("ã€Œå…¬é–‹éµã€ã§ç½²åã‚’å¾©å·ã—ã¾ã™...");
        
        document.getElementById('proc-b').innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center;">
                ${createItemHTML('i-sig', 'ğŸ–Šï¸ğŸ”’', 'ç½²å')}
                <div style="margin-top:10px; text-align:center;">
                    <div style="font-size:3rem; margin-bottom:5px;" class="key-anim">ğŸ”‘</div>
                    <div style="font-size:1.1rem; font-weight:bold; color:#059669;">å…¬é–‹éµã§é–‹éŒ ä¸­...</div>
                </div>
            </div>`;
            
        await wait(SPEED.PROCESS);
        await wait(2000); 

        boxB.innerHTML = `<span class="label">çµæœ</span>${createItemHTML('i-hash fade-in', 'ğŸ“¦', 'ãƒãƒƒã‚·ãƒ¥å€¤', 'å¾©å·çµæœ')}`;
        await blinkMsg("ãƒ«ãƒ¼ãƒˆBå®Œäº†ï¼šç½²åã‹ã‚‰å…ƒã®ãƒãƒƒã‚·ãƒ¥å€¤ãŒå‡ºã¾ã—ãŸã€‚");
        await wait(2000); 

        // åˆ¤å®š
        msg("æ¯”è¼ƒçµæœãŒå‡ºã¾ã—ãŸï¼");
        const resDiv = document.getElementById('final-result');
        if(isTampered) {
            resDiv.innerHTML = `<div class="result-card res-ng"><h3>âŒ ä¸ä¸€è‡´ (æ”¹ã–ã‚“æ¤œçŸ¥)</h3><p>ãƒãƒƒã‚·ãƒ¥å€¤ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚<br>ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›¸ãæ›ãˆã‚‰ã‚Œã¦ã„ã¾ã™ï¼</p></div>`;
        } else {
            resDiv.innerHTML = `<div class="result-card res-ok"><h3>âœ… ä¸€è‡´ (æ¤œè¨¼æˆåŠŸ)</h3><p>ãƒãƒƒã‚·ãƒ¥å€¤ãŒä¸€è‡´ã—ã¾ã—ãŸã€‚<br>ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ¬ç‰©ã§ã™ã€‚</p></div>`;
        }
        
        // è§£èª¬ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆç¢ºå®Ÿã«è¡¨ç¤ºï¼‰
        await wait(3000);
        document.getElementById('final-overlay').classList.add('visible');

        isRunning = false;
    }
</script>

</body>
</html>
