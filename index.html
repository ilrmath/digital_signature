<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚¸ã‚¿ãƒ«ç½²å & é›»å­è¨¼æ˜æ›¸ ä½“é¨“ãƒ©ãƒœ</title>
    <style>
        :root {
            --sender: #3b82f6;    /* é’: é€ä¿¡è€… */
            --receiver: #8b5cf6;  /* ç´«: å—ä¿¡è€… */
            --hacker: #ef4444;    /* èµ¤: æ”¹ã–ã‚“è€… */
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --hash-color: #f59e0b; /* ã‚ªãƒ¬ãƒ³ã‚¸: ãƒãƒƒã‚·ãƒ¥å€¤ */
            --cert-bg: #e0f2fe;
            --cert-border: #38bdf8;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-top: 5px solid var(--sender);
        }

        h1 { margin: 0; font-size: 1.8em; }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
            border-left: 6px solid #ccc;
        }

        .role-sender { border-left-color: var(--sender); }
        .role-network { border-left-color: var(--hacker); background-color: #fef2f2; }
        .role-receiver { border-left-color: var(--receiver); }

        .step-badge {
            background: #333; color: white;
            width: 30px; height: 30px;
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-weight: bold; margin-right: 10px;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;
            font-size: 16px; box-sizing: border-box; font-family: monospace;
        }

        button {
            border: none; padding: 10px 20px; border-radius: 6px;
            cursor: pointer; font-size: 16px; font-weight: bold; transition: opacity 0.2s;
            color: white; margin-top: 10px;
        }
        button:hover { opacity: 0.9; }
        .btn-sender { background-color: var(--sender); }
        .btn-hacker { background-color: var(--hacker); }
        .btn-receiver { background-color: var(--receiver); }

        /* ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ãƒœãƒƒã‚¯ã‚¹ */
        .data-box {
            background: #f8fafc;
            border: 1px dashed #cbd5e1;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            word-break: break-all;
        }
        .hash-val { color: var(--hash-color); font-weight: bold; font-size: 1.8em; }
        .sign-val { color: var(--sender); font-weight: bold; font-size: 2.5em; line-height: 1; }
        
        /* è¨¼æ˜æ›¸ã‚«ãƒ¼ãƒ‰ */
        .cert-card {
            background: white;
            border: 2px solid var(--cert-border);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        .cert-card::before {
            content: "CERTIFICATE";
            position: absolute;
            top: 5px; right: -20px;
            background: var(--cert-border);
            color: white;
            font-size: 0.6em;
            padding: 2px 20px;
            transform: rotate(45deg);
        }
        .cert-icon { font-size: 2.5em; display: block; margin-bottom: 5px; }

        /* é…é€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (Step 3) */
        .transit-container {
            display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px;
        }
        .transit-item {
            flex: 1; min-width: 150px; background: white; padding: 15px 10px;
            border-radius: 8px; border: 1px solid #ddd; text-align: center;
        }
        .transit-item label { text-align: left; margin-top: 5px; display: block; }
        .transit-big-icon { font-size: 4em; display: block; margin-bottom: 5px; line-height: 1; }

        /* Step 2: ãƒãƒƒã‚·ãƒ¥åŒ–ã®ã‚¤ãƒ¡ãƒ¼ã‚¸è¡¨ç¾ç”¨ */
        .hash-visual-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            background: #fffbeb;
            padding: 20px;
            border-radius: 6px;
        }
        .hash-icon-box { text-align: center; }
        .hash-icon-img { font-size: 3.5em; display: block; line-height: 1; margin-bottom: 5px; }
        .hash-label { font-size: 1.1em; font-weight: bold; color: #444; }
        .hash-arrow-box { text-align: center; color: #d97706; }

        /* Step 2: ç½²åç”Ÿæˆãƒ•ãƒ­ãƒ¼ç”¨ */
        .sign-flow-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        .signature-icon-set {
            font-size: 2.5em; margin-left: 15px; vertical-align: middle;
        }

        /* ========== Step 4: æ¤œè¨¼å›³è§£ç”¨CSS ========== */
        .visual-verification {
            display: flex; align-items: stretch; justify-content: space-between;
            margin-top: 20px; background: #f0f4f8; border-radius: 10px; padding: 20px; gap: 15px;
        }
        .verify-col {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            background: white; padding: 20px 10px; border-radius: 8px;
            border: 2px solid transparent; position: relative;
        }
        .verify-col.left { border-color: #cbd5e1; }
        .verify-col.left::before { content: "ãƒ«ãƒ¼ãƒˆA: æ–‡æ›¸ã‹ã‚‰"; position: absolute; top:-12px; background:#cbd5e1; padding:4px 12px; font-size:0.9em; border-radius:4px; font-weight:bold; color:#333; }
        .verify-col.right { border-color: #86efac; }
        .verify-col.right::before { content: "ãƒ«ãƒ¼ãƒˆB: ç½²åã‹ã‚‰"; position: absolute; top:-12px; background:#86efac; padding:4px 12px; font-size:0.9em; border-radius:4px; font-weight:bold; color:#064e3b; }
        
        .verify-icon { font-size: 3.5em; margin-bottom: 5px; display: block; }
        .verify-top-label { font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 10px; }
        .process-arrow { font-size: 2.5em; color: #94a3b8; margin: 5px 0; font-weight: bold; }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒƒã‚¸ */
        .action-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 20px; border-radius: 50px;
            color: white; font-weight: bold; font-size: 1.2em;
            margin: 5px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .bg-hash { background-color: #ea580c; } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
        .bg-decrypt { background-color: #10b981; } /* ç·‘ */
        
        .badge-icon-circle {
            background: white; width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #333; font-size: 1.2em; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
        }

        /* çµæœæ•°å€¤ãƒœãƒƒã‚¯ã‚¹ */
        .verify-result-box {
            background-color: #fef3c7; 
            border-radius: 12px; padding: 15px 25px;
            font-family: monospace; font-size: 2.2em; font-weight: bold;
            color: #d97706; margin: 10px 0; min-width: 80px; text-align: center;
        }
        
        .comparison-center {
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; font-weight: bold; font-size: 1.4em; width: 60px;
        }

        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .final-judgment {
            margin-top: 20px; padding: 15px; border-radius: 8px;
            text-align: center; font-weight: bold; display: none;
        }
        .judgment-ok { background-color: #dcfce7; border: 2px solid #22c55e; color: #15803d; font-size: 1.2em; }
        .judgment-ng { background-color: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; font-size: 1.2em; }

        var {
            font-style: normal; font-weight: bold; font-family: monospace;
            background: #eee; padding: 0 4px; border-radius: 3px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ» ãƒ‡ã‚¸ã‚¿ãƒ«ç½²å & é›»å­è¨¼æ˜æ›¸</h1>
        <p>ã€Œã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ¬ç‰©ï¼Ÿã€ã€Œæœ¬å½“ã«ãã¾ã•ã‚“ã‹ã‚‰ï¼Ÿã€<br>
        ãƒ•ã‚¡ã‚¤ãƒ«ã¨ä¸€ç·’ã«<strong style="color:var(--sender);">ã€Œé›»å­è¨¼æ˜æ›¸ã€</strong>ã‚’é€ã‚‹ã“ã¨ã§ã€å®‰å…¨æ€§ã‚’è¨¼æ˜ã§ãã¾ã™ã€‚</p>
    </div>

    <div class="card role-sender">
        <h2><span class="step-badge">1</span> é€ä¿¡è€…ï¼ˆãã¾ï¼‰: éµã¨è¨¼æ˜æ›¸ã®ç™ºè¡Œ</h2>
        <p>èªè¨¼å±€ã‹ã‚‰ã€Œé›»å­è¨¼æ˜æ›¸ï¼ˆå…¬é–‹éµå…¥ã‚Šï¼‰ã€ã‚’ç™ºè¡Œã—ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚</p>

        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
            <div>
                <label>ç´ æ•° p</label>
                <input type="number" id="p-val" value="17" style="width: 80px;">
            </div>
            <div>
                <label>ç´ æ•° q</label>
                <input type="number" id="q-val" value="19" style="width: 80px;">
            </div>
            <button class="btn-sender" onclick="generateKeys()">éµãƒšã‚¢ã‚’ä½œæˆ & è¨¼æ˜æ›¸ç™ºè¡Œ ğŸ”‘</button>
        </div>

        <div id="key-display" style="display: none; margin-top: 15px;">
            <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
                <div class="data-box" style="flex: 1; border-left: 4px solid var(--sender);">
                    <strong>ğŸ”’ ãã¾ã®ç§˜å¯†éµ</strong><br>
                    d=<span id="priv-key-d"></span>, n=<span id="priv-key-n"></span><br>
                    <small>â€» çµ¶å¯¾ã«ç§˜å¯†ï¼ç½²åã«ä½¿ã„ã¾ã™ã€‚</small>
                </div>
                
                <div class="cert-card" style="flex: 1; min-width: 200px;">
                    <span class="cert-icon">ğŸªª</span>
                    <strong>é›»å­è¨¼æ˜æ›¸</strong>
                    <hr style="margin: 5px 0; border: 0; border-top: 1px solid #eee;">
                    <div style="font-size: 0.9em; text-align: left; padding: 0 5px;">
                        <div>æ‰€æœ‰è€…: <strong>ãã¾</strong></div>
                        <div>ç™ºè¡Œå…ƒ: <strong>XYZèªè¨¼å±€</strong></div>
                        <div style="background: #f0f9ff; padding: 3px; border-radius: 4px; margin-top: 3px; font-size:0.9em;">
                            ğŸ”‘ å…¬é–‹éµ: <br>
                            e=<span id="pub-key-e" style="font-weight:bold;"></span>, n=<span id="pub-key-n" style="font-weight:bold;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card role-sender">
        <h2><span class="step-badge">2</span> é€ä¿¡è€…: æ–‡æ›¸ä½œæˆã¨ç½²å</h2>
        <p>æ–‡æ›¸ã‚’ä½œæˆã—ã€ç§˜å¯†éµã§ç½²åã—ã¾ã™ã€‚</p>

        <div class="input-group">
            <label>é€ã‚ŠãŸã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
            <textarea id="message-input" rows="3">ãŠã’ã‚“ãã§ã™ã‹ï¼Ÿãã¾ã‚ˆã‚Š</textarea>
        </div>

        <button class="btn-sender" onclick="signMessage()">ç½²åã—ã¦é€ä¿¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã‚‹ ğŸ“¦</button>

        <div id="sign-result" style="display: none;">
            <div class="arrow-down" style="margin-bottom: 10px;">â¬‡</div>
            <div class="data-box">
                <div style="margin-bottom: 5px; font-weight: bold; font-size:1.2em;">1. ãƒãƒƒã‚·ãƒ¥åŒ– (è¦ç´„)</div>
                
                <div class="hash-visual-row">
                    <div class="hash-icon-box">
                        <span class="hash-icon-img">ğŸ“„</span>
                        <div class="hash-label">æ–‡æ›¸</div>
                    </div>
                    
                    <div class="hash-arrow-box">
                        <span style="font-size: 2.5em; display: block;">â†’</span>
                        <span style="font-size: 3em; display: block; margin-top: -15px;">ğŸŒ€</span>
                        <small style="font-size: 0.9em; font-weight:bold; white-space: nowrap;">ãã—ã‚ƒãã—ã‚ƒ</small>
                    </div>
                    
                    <div class="hash-icon-box">
                        <span class="hash-icon-img">ğŸ“¦</span>
                        <div class="hash-label">ãƒãƒƒã‚·ãƒ¥</div>
                    </div>
                    
                    <div style="font-size: 2em; margin-left: 10px; font-family: monospace; color: var(--hash-color);">
                        = <span id="msg-hash"></span>
                    </div>
                </div>
                
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 20px 0;">
                
                <div>
                    <div style="font-weight: bold; margin-bottom: 10px; font-size:1.2em;">2. ç½²åç”Ÿæˆ (ç§˜å¯†éµdã§æš—å·åŒ–):</div>
                    
                    <div class="sign-flow-row">
                        <span style="font-size: 3em;">ğŸ“¦</span> 
                        <span style="font-size: 2em;">â†’</span> 
                        <span style="font-size: 2.5em;">ğŸ—ï¸</span> 
                        <span style="font-size: 2em;">â†’</span>
                        
                        <div style="background: #eff6ff; padding: 10px 20px; border-radius: 12px; border: 2px solid #bfdbfe; display: flex; align-items: center;">
                            <span id="digital-signature" class="sign-val"></span>
                            <span class="signature-icon-set">ğŸ”’ğŸ–‹ï¸</span>
                        </div>
                    </div>
                </div>
            </div>
            <div style="margin-top: 15px; text-align: center; font-weight: bold; color: var(--sender); font-size: 1.1em;">
                ğŸ‘‡ ä»¥ä¸‹ã®3ç‚¹ã‚»ãƒƒãƒˆã‚’ç›¸æ‰‹ã«é€ã‚Šã¾ã™ï¼
            </div>
        </div>
    </div>

    <div class="card role-network">
        <h2><span class="step-badge">3</span> ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆï¼ˆé…é€ä¸­...ï¼‰</h2>
        <p>ãƒ‡ãƒ¼ã‚¿ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æµã‚Œã¦ã„ãã¾ã™ã€‚</p>

        <div class="transit-container">
            <div class="transit-item">
                <span class="transit-big-icon">ğŸ“„</span>
                <label>1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                <textarea id="transit-message" rows="4" style="font-size: 0.9em;"></textarea>
            </div>
            
            <div class="transit-item" style="background: #fdf2f8;">
                <span class="transit-big-icon">ğŸ”’ğŸ–‹ï¸</span>
                <label>2. ãƒ‡ã‚¸ã‚¿ãƒ«ç½²å</label>
                
                <div style="display: flex; align-items: center; justify-content: center; margin-top: 15px;">
                    <input type="text" id="transit-signature" style="text-align:right; font-weight:bold; font-size: 1.5em; width: 70%;">
                    <span style="font-size: 2.5em; margin-left: 5px;">ğŸ”’</span>
                </div>
                
                <div style="font-size: 0.8em; color: #666; margin-top: 5px; text-align: left;">â€»ç§˜å¯†éµã«ã‚ˆã‚‹æš—å·</div>
            </div>

            <div class="transit-item" style="background: #f0f9ff; border-color: var(--cert-border);">
                <span class="transit-big-icon">ğŸ›ï¸</span>
                <label>3. é›»å­è¨¼æ˜æ›¸</label>
                <div style="font-size: 0.8em; text-align: center; line-height: 1.4; margin-top: 5px;">
                    <strong>ğŸ”‘ å…¬é–‹éµå…¥ã‚Š</strong><br>
                    <span style="background: #fff; border:1px solid #ccc; padding:2px 4px; border-radius:3px; display:inline-block; margin-top:5px;">
                        e=<span id="transit-e">?</span>, n=<span id="transit-n">?</span>
                    </span>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 15px;">
            <button class="btn-hacker" onclick="tamperMessage()">ğŸ˜ˆ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹ã–ã‚“ã™ã‚‹</button>
            <p style="font-size: 0.8em; margin-top: 5px;">ï¼ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã ã‘ãŒæ›¸ãæ›ã‚ã‚Šã¾ã™ï¼‰</p>
        </div>
    </div>

    <div class="card role-receiver">
        <h2><span class="step-badge">4</span> å—ä¿¡è€…: æ¤œè¨¼ï¼ˆç­”ãˆåˆã‚ã›ï¼‰</h2>
        <p>å±Šã„ãŸã€Œé›»å­è¨¼æ˜æ›¸ã€ã®ä¸­ã«ã‚ã‚‹å…¬é–‹éµã‚’ä½¿ã£ã¦ã€ç½²åã‚’æ¤œè¨¼ã—ã¾ã™ã€‚</p>

        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: #e0e7ff; padding: 10px; border-radius: 6px;">
            <span style="font-size: 2em;">ğŸªª</span>
            <div style="font-size: 0.9em;">
                <strong>è¨¼æ˜æ›¸ã®ç¢ºèª:</strong><br>
                ã€Œã“ã‚Œã¯XYZå±€ãŒç™ºè¡Œã—ãŸã€ãã¾ã€ã®è¨¼æ˜æ›¸ã ã€‚<br>
                ã“ã®ä¸­ã®å…¬é–‹éµ(ğŸ”‘ e=<strong id="verify-e" style="color:#0369a1;">?</strong>)ã‚’ä½¿ã£ã¦ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†ï¼ã€
            </div>
        </div>

        <button class="btn-receiver" onclick="verifySignature()">ç½²åã‚’æ¤œè¨¼ã™ã‚‹ ğŸ”</button>

        <div id="verify-process" style="display: none;">
            <div class="visual-verification">
                
                <div class="verify-col left">
                    <span class="verify-icon">ğŸ“„</span>
                    <div class="verify-top-label">å±Šã„ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                    
                    <div class="process-arrow">â¬‡</div>
                    
                    <div class="action-badge bg-hash">
                        <div class="badge-icon-circle">ğŸŒ€</div>
                        <span>ãƒãƒƒã‚·ãƒ¥åŒ–</span>
                    </div>

                    <div class="process-arrow">â¬‡</div>
                    
                    <div class="verify-result-box" id="calc-hash-recv">---</div>
                    
                    <div style="text-align: center;">
                        <span style="font-size: 3.5em; display: block; margin-bottom: 5px;">ğŸ“¦</span>
                        <div style="font-weight: bold; font-size: 1.3em;">ä»Šã®ç®± (A)</div>
                    </div>
                </div>

                <div class="comparison-center">
                    <div style="font-size:4em; line-height:1;" id="compare-icon">=</div>
                    <div style="font-size:1em; color:#666; margin-top:10px;">æ¯”è¼ƒ</div>
                </div>

                <div class="verify-col right">
                    <span class="verify-icon">ğŸ”’ğŸ–‹ï¸</span>
                    <div class="verify-top-label">å±Šã„ãŸç½²å</div>
                    
                    <div class="process-arrow">â¬‡</div>
                    
                    <div class="action-badge bg-decrypt">
                        <div class="badge-icon-circle">ğŸ”‘</div>
                        <span>å…¬é–‹éµã§å¾©å·</span>
                    </div>

                    <div class="process-arrow">â¬‡</div>
                    
                    <div class="verify-result-box" id="decrypted-hash">---</div>
                    
                    <div style="text-align: center;">
                        <span style="font-size: 3.5em; display: block; margin-bottom: 5px;">ğŸ“¦</span>
                        <div style="font-weight: bold; font-size: 1.3em;">å…ƒã®ç®± (B)</div>
                    </div>
                </div>
            </div>

            <div id="final-judgment" class="final-judgment"></div>
        </div>
    </div>

</div>

<script>
    // --- RSAè¨ˆç®—ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (BigIntå¯¾å¿œ) ---
    let keys = { n: 0n, e: 0n, d: 0n };

    function gcd(a, b) { return b === 0n ? a : gcd(b, a % b); }

    function modInverse(e, phi) {
        let m0 = phi, y = 0n, x = 1n;
        if (phi === 1n) return 0n;
        while (e > 1n) {
            let q = e / phi;
            let t = phi; phi = e % phi; e = t;
            t = y; y = x - q * y; x = t;
        }
        if (x < 0n) x += m0;
        return x;
    }

    function modPow(base, exp, mod) {
        let res = 1n;
        base = base % mod;
        while (exp > 0n) {
            if (exp % 2n === 1n) res = (res * base) % mod;
            base = (base * base) % mod;
            exp /= 2n;
        }
        return res;
    }

    function isPrime(num) {
        if (num <= 1) return false;
        for(let i=2; i*i <= num; i++) if(num % i === 0) return false;
        return true;
    }

    // ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥é–¢æ•°
    function simpleHash(str, n) {
        let sum = 0n;
        for (let i = 0; i < str.length; i++) {
            sum += BigInt(str.charCodeAt(i));
        }
        return sum % n; 
    }

    // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---

    function generateKeys() {
        const pVal = parseInt(document.getElementById('p-val').value);
        const qVal = parseInt(document.getElementById('q-val').value);

        if (!isPrime(pVal) || !isPrime(qVal) || pVal === qVal) {
            alert("pã¨qã¯ç•°ãªã‚‹ç´ æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„");
            return;
        }

        const p = BigInt(pVal);
        const q = BigInt(qVal);
        keys.n = p * q;
        const phi = (p - 1n) * (q - 1n);

        let e = 3n;
        while (gcd(e, phi) !== 1n) e += 2n;
        keys.e = e;
        keys.d = modInverse(e, phi);

        // UIæ›´æ–°
        document.getElementById('priv-key-d').innerText = keys.d;
        document.getElementById('priv-key-n').innerText = keys.n;
        document.getElementById('pub-key-e').innerText = keys.e;
        document.getElementById('pub-key-n').innerText = keys.n;
        document.getElementById('transit-e').innerText = keys.e;
        document.getElementById('transit-n').innerText = keys.n;
        document.getElementById('verify-e').innerText = keys.e;

        document.getElementById('key-display').style.display = 'block';
        resetSteps();
    }

    function signMessage() {
        if (keys.n === 0n) { alert("ã¾ãšã¯Step1ã§éµã‚’ä½œæˆã—ã¦ãã ã•ã„"); return; }
        
        const msg = document.getElementById('message-input').value;
        if (!msg) { alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        const hashVal = simpleHash(msg, keys.n);
        const signature = modPow(hashVal, keys.d, keys.n);

        document.getElementById('msg-hash').innerText = hashVal;
        document.getElementById('digital-signature').innerText = signature;
        document.getElementById('sign-result').style.display = 'block';

        document.getElementById('transit-message').value = msg;
        document.getElementById('transit-signature').value = signature;
        
        resetVerificationUI();
    }

    function tamperMessage() {
        const currentMsg = document.getElementById('transit-message').value;
        if (!currentMsg) return;

        document.getElementById('transit-message').value = "é‡‘æ‰•ãˆï¼ã™ãæ‰•ãˆï¼ãã¾ã‚ˆã‚Š";
        
        alert("ğŸ˜ˆ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹ã–ã‚“ã—ã¾ã—ãŸï¼\nï¼ˆç½²åã¨è¨¼æ˜æ›¸ã¯ãã®ã¾ã¾ã§ã™ï¼‰");
    }

    function verifySignature() {
        if (keys.n === 0n) return;

        const receivedMsg = document.getElementById('transit-message').value;
        const receivedSigStr = document.getElementById('transit-signature').value;

        if (!receivedMsg || !receivedSigStr) {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒå±Šã„ã¦ã„ã¾ã›ã‚“");
            return;
        }

        const receivedSig = BigInt(receivedSigStr);
        const calcHash = simpleHash(receivedMsg, keys.n);
        const decryptedHash = modPow(receivedSig, keys.e, keys.n);

        // UIæ›´æ–°
        document.getElementById('verify-process').style.display = 'block';
        document.getElementById('calc-hash-recv').innerText = calcHash;
        document.getElementById('decrypted-hash').innerText = decryptedHash;

        const resultDiv = document.getElementById('final-judgment');
        const compareIcon = document.getElementById('compare-icon');
        resultDiv.style.display = "block";

        if (calcHash === decryptedHash) {
            compareIcon.innerText = "ï¼";
            compareIcon.style.color = "green";
            resultDiv.className = "final-judgment judgment-ok";
            resultDiv.innerHTML = `
                <h3>âœ… æ¤œè¨¼æˆåŠŸï¼ˆä¸€è‡´ï¼‰</h3>
                <p>ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯é–“é•ã„ãªãã€Œãã¾ã€ã‹ã‚‰ã®ã‚‚ã®ã§ã€æ”¹ã–ã‚“ã‚‚ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
            `;
        } else {
            compareIcon.innerText = "â‰ ";
            compareIcon.style.color = "red";
            resultDiv.className = "final-judgment judgment-ng";
            resultDiv.innerHTML = `
                <h3>âŒ æ¤œè¨¼å¤±æ•—ï¼ˆä¸ä¸€è‡´ï¼‰</h3>
                <p>ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒæ”¹ã–ã‚“ã•ã‚ŒãŸã‹ã€ç½²åãŒå½ç‰©ã§ã™ã€‚</p>
            `;
        }
    }

    function resetSteps() {
        document.getElementById('sign-result').style.display = 'none';
        document.getElementById('transit-message').value = "";
        document.getElementById('transit-signature').value = "";
        resetVerificationUI();
    }

    function resetVerificationUI() {
        document.getElementById('verify-process').style.display = 'none';
        document.getElementById('final-judgment').style.display = 'none';
        document.getElementById('compare-icon').innerText = "â“";
        document.getElementById('compare-icon').style.color = "black";
    }
</script>

</body>
</html>
